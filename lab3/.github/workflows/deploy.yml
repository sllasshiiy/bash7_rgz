name: Quadratic Equation CI/CD Pipeline

on:
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main
  push:
    branches: [ main ]
  
  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request –≤ main
  pull_request:
    branches: [ main ]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å GitHub Actions
  workflow_dispatch:

jobs:
  # Job 1: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
  test-and-coverage:
    name: –¢–µ—Å—Ç—ã –∏ –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞
    runs-on: ubuntu-latest
    
    steps:
    - name:  –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name:  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name:  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name:  –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
      run: |
        python -m pytest tests/ -v
        
    - name:  –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞ —Ç–µ—Å—Ç–∞–º–∏
      run: |
        python -m pytest tests/ --cov=src --cov-report=xml --cov-report=html --cov-report=term-missing
        
    - name:  –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30

  # Job 2: –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  lint-and-security:
    name:  –õ–∏–Ω—Ç–∏–Ω–≥ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
    runs-on: ubuntu-latest
    needs: test-and-coverage  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    
    steps:
    - name:  –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4
      
    - name:  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name:  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        pip install -r requirements.txt
        
    - name:  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞ —Å flake8
      run: |
        echo "=== Flake8 Code Linting ==="
        flake8 src/ tests/ --max-line-length=100 --show-source --statistics
        
    - name:  –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å bandit
      run: |
        echo "=== Bandit Security Check ==="
        bandit -r src/ -f json -o bandit-report.json -ll
        echo "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
        
    - name:  –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
      uses: actions/upload-artifact@v3
      with:
        name: security-report
        path: bandit-report.json
        retention-days: 30

  # Job 3: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
  telegram-notification:
    name:  –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
    runs-on: ubuntu-latest
    needs: [test-and-coverage, lint-and-security]  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö jobs
    if: always()  # –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ jobs —É–ø–∞–ª–∏
    
    steps:
    - name:  –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ Telegram
      run: |
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if [ "${{ job.status }}" == "success" ]; then
          EMOJI="‚úÖ"
          STATUS="–£–°–ü–ï–®–ù–û –í–´–ü–û–õ–ù–ï–ù"
          MESSAGE="–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!%0A%0A‚úì –¢–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã%0A‚úì –ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º%0A‚úì –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"
        else
          EMOJI="‚ùå"
          STATUS="–ó–ê–í–ï–†–®–ò–õ–°–Ø –° –û–®–ò–ë–ö–ê–ú–ò"
          MESSAGE="–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ.%0A–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è."
        fi
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        TELEGRAM_MESSAGE="$EMOJI *CI/CD Pipeline* - $STATUS%0A%0AüìÅ *–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:* ${{ github.repository }}%0AüîÄ *–í–µ—Ç–∫–∞:* ${{ github.ref_name }}%0Aüë§ *–ê–≤—Ç–æ—Ä:* ${{ github.actor }}%0Aüìù *–ö–æ–º–º–∏—Ç:* ${GITHUB_SHA:0:8}%0A%0A$MESSAGE%0A%0Aüìä *–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:*%0A${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Bot API
        curl -s -X POST \
          "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d text="$TELEGRAM_MESSAGE" \
          -d parse_mode="Markdown" \
          -d disable_web_page_preview="true"